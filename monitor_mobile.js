const SVG_NS="http://www.w3.org/2000/svg";
let svgWrap,tooltip;
function normalizeId(s){if(!s)return'';try{s=s.normalize('NFKC')}catch(e){}return String(s).trim()}
function normalizeName(n){if(!n)return'';let s=String(n);try{s=s.normalize('NFKC')}catch(e){}s=s.replace(/\uff08.*?\uff09/g,'');s=s.replace(/\(.*?\)/g,'');s=s.replace(/\u3000/g,'');s=s.replace(/\s+/g,'');s=s.replace(/・/g,'');return s.trim().toLowerCase()}
function digitsOnly(s){if(!s)return'';const m=String(s).normalize('NFKC').match(/(\d{1,6})/);return m?m[1].replace(/^0+/,'')||'0':''}
const EW_STATIONS=["伊野","伊野駅前","鳴谷","北山","北内","伊野商業前","枝川","中山","八代通","宇治団地前","咥内","宮の奥","朝倉神社前","朝倉駅前","朝倉","曙町","曙町東町","鴨部","鏡川橋","蛍橋","旭町三丁目","旭駅前通","旭町一丁目","上町五丁目","上町四丁目","上町二丁目","上町一丁目","枡形","グランド通","県庁前","高知城前","大橋通","堀詰","はりまや橋","デンテツ・ターミナルビル前","菜園場町","宝永町","知寄町一丁目","知寄町二丁目","知寄町","知寄町三丁目","葛島橋東詰","西高須","県立美術館通","高須","文珠通","介良通","新木","東新木","田辺島通","鹿児","舟戸","北浦","領石通","清和学園前","一条橋","明見橋","長崎","小篭通","篠原","住吉通","東工業前","後免西町","後免中町","後免東町","後免町"];
const SN_STATIONS=["高知駅前","高知橋","蓮池町通","はりまや橋","梅の辻","桟橋通一丁目","桟橋通二丁目","桟橋通三丁目","桟橋通四丁目","桟橋車庫前","桟橋通五丁目"];
function displayStationName(n){if(!n)return n;if(/デンテツ.*ターミナル.*ビル/i.test(n))return'デンタミ';if(/後免西町/i.test(n))return'ごめん西町';if(/後免中町/i.test(n))return'ごめん中町';if(/後免東町/i.test(n))return'ごめん東町';if(/後免町/i.test(n))return'ごめん町';if(/菜園場町|菜園前/i.test(n))return'菜園場町';return n}
const getColumns=()=>10;
let per=Math.ceil(EW_STATIONS.length/getColumns());
function buildROWS_STATIONS(){const cols=getColumns();per=Math.ceil(EW_STATIONS.length/cols);const rows=[];for(let i=0;i<cols;i++){const start=i*per;const end=Math.min((i+1)*per,EW_STATIONS.length);if(start<EW_STATIONS.length){rows.push(EW_STATIONS.slice(start,end))}}const snCols=2;const snPer=Math.ceil(SN_STATIONS.length/snCols);for(let i=0;i<snCols;i++){const start=i*snPer;const end=Math.min((i+1)*snPer,SN_STATIONS.length);if(start<SN_STATIONS.length){rows.push(SN_STATIONS.slice(start,end))}}return rows}
let ROWS_STATIONS=buildROWS_STATIONS();
const ROWS=ROWS_STATIONS.length;
let viewW=1400,viewH=800;
const marginLeft=20,marginRight=20,marginTop=30,marginBottom=30;
let rowY=[],stationPos=[];
let stopsById={},trips={},tripRoute={},opMap={},destMap={},tripDayType={},currentDayType='weekday',waitingTrains={},tripsByOperation={};
const destCharMap=[{pat:/伊野/,char:'伊'},{pat:/後免|ごめん/,char:'後'},{pat:/高知駅|高知/,char:'高'},{pat:/桟橋通五丁目|桟橋五丁目/,char:'桟'},{pat:/桟橋通四丁目|桟橋四丁目/,char:'四'},{pat:/はりまや/,char:'橋'},{pat:/朝倉/,char:'朝'},{pat:/鏡川橋/,char:'鏡'},{pat:/枡形/,char:'枡'},{pat:/知寄町/,char:'知'},{pat:/文珠通/,char:'文'},{pat:/介良通/,char:'介'},{pat:/領石通/,char:'領'}];
function getLocalSecondsOfDay(){const d=new Date();return d.getHours()*3600+d.getMinutes()*60+d.getSeconds()}
let currentTime=getLocalSecondsOfDay();
function nowSeconds(){return getLocalSecondsOfDay()}
let anim=null,lastTs=null,playRate=1;
async function loadUnyoIfExists(){const candidates=[{url:'unyo_平日.csv',type:'weekday'},{url:'data/unyo_平日.csv',type:'weekday'},{url:'unyo_土日祝.csv',type:'holiday'},{url:'data/unyo_土日祝.csv',type:'holiday'}];let lw=0,lh=0;for(const{url,type}of candidates){try{const res=await fetch(url);if(!res.ok)continue;let txt=await res.text();txt=txt.replace(/^\uFEFF/,'');const lines=txt.split(/\r?\n/).filter(l=>l.trim());if(lines.length<2)continue;const hdr=lines[0];const delim=hdr.indexOf('\t')>=0?'\t':',';const header=hdr.split(delim).map(h=>h.trim());let idxTrip=-1,idxOp=-1,idxDest=-1;for(let i=0;i<header.length;i++){const h=header[i]||'';if(h.includes('trip_id'))idxTrip=i;if(h.includes('仕業番号'))idxOp=i;if(h.includes('終着駅'))idxDest=i}let c=0;for(let i=1;i<lines.length;i++){const line=lines[i];if(!line||!line.trim())continue;const cols=line.split(delim).map(c=>c.trim());if(!cols.length)continue;const rawTid=(idxTrip>=0?cols[idxTrip]:'').trim();if(!rawTid)continue;const tid=normalizeId(rawTid);const rawOp=(idxOp>=0?cols[idxOp]:'').trim();const opNum=rawOp.match(/(\d+)/);const op=opNum?opNum[1]:'';const dest=(idxDest>=0?cols[idxDest]:'').trim();if(tid){if(op)opMap[tid]=op;if(dest)destMap[tid]=dest;tripDayType[tid]=type;c++}}if(type==='weekday')lw+=c;else lh+=c;console.info('unyo',url,c)}catch(e){continue}}console.info('unyo total: weekday',lw,'holiday',lh)}
async function loadCSV(url){const res=await fetch(url);if(!res.ok)throw new Error(url+' failed');const txt=await res.text();const lines=txt.replace(/^\uFEFF/,'').split(/\r?\n/);let i=0;while(i<lines.length&&!lines[i].trim())i++;if(i>=lines.length)return[];const hdr=lines[i].split(',').map(h=>h.trim());const rows=[];for(let j=i+1;j<lines.length;j++){if(!lines[j]||!lines[j].trim())continue;const parts=lines[j].split(',');const obj={};for(let k=0;k<hdr.length;k++)obj[hdr[k]]=(parts[k]||'').trim();rows.push(obj)}return rows}
async function loadData(){const srows=await loadCSV('data/stops.txt');srows.forEach(r=>{if(r.stop_id)stopsById[r.stop_id]={name:r.stop_name}});const st=await loadCSV('data/stop_times.txt');const tmp={};st.forEach(r=>{const rawTid=r.trip_id;if(!rawTid)return;if(!tmp[rawTid])tmp[rawTid]=[];const arrival=hhmmssToSec(r.arrival_time);const departure=hhmmssToSec(r.departure_time);const seq=parseInt(r.stop_sequence||'0',10);const sid=r.stop_id;const name=(stopsById[sid]&&stopsById[sid].name)||r.stop_name||'';tmp[rawTid].push({stop_id:sid,stop_name:name,arrival,departure,seq})});Object.keys(tmp).forEach(rawTid=>{const tid=normalizeId(rawTid);const arr=tmp[rawTid].sort((a,b)=>a.seq-b.seq);arr.forEach(e=>{if(e.arrival==null&&e.departure!=null)e.arrival=e.departure;if(e.departure==null&&e.arrival!=null)e.departure=e.arrival;if(e.stop_name)e.stop_name=e.stop_name.trim()});trips[tid]=arr.map(e=>({...e}));if(!tripDayType[tid]){if(rawTid.includes('平日_'))tripDayType[tid]='weekday';else if(rawTid.includes('土日祝_'))tripDayType[tid]='holiday';else tripDayType[tid]='weekday'}});classifyTrips();buildOperationGroups()}
function classifyTrips(){Object.keys(trips).forEach(tid=>{const names=trips[tid].map(s=>s.stop_name);const set=new Set(names);const hasEWEnd=set.has('伊野')||set.has('後免町')||set.has('ごめん');const hasSNEnd=set.has('高知駅前')||set.has('桟橋通五丁目')||set.has('桟橋車庫前');const hasSN=hasSNEnd||set.has('高知橋')||set.has('蓮池町通')||set.has('桟橋通四丁目')||set.has('桟橋通三丁目')||set.has('桟橋通二丁目')||set.has('桟橋通一丁目')||set.has('梅の辻');if(hasEWEnd)tripRoute[tid]='EW';else if(hasSN&&!hasEWEnd)tripRoute[tid]='SN';else tripRoute[tid]='UNK'})}
function buildOperationGroups(){tripsByOperation={};Object.keys(trips).forEach(tid=>{const opNum=opMap[tid];if(!opNum)return;const dayType=tripDayType[tid]||'weekday';const key=dayType+'_'+opNum;if(!tripsByOperation[key])tripsByOperation[key]=[];const seq=trips[tid];const firstDep=seq.length>0&&seq[0].departure!=null?seq[0].departure:0;tripsByOperation[key].push({tid,firstDeparture:firstDep})});Object.keys(tripsByOperation).forEach(key=>{tripsByOperation[key].sort((a,b)=>a.firstDeparture-b.firstDeparture)})}
function getOperationNumber(tid,fallbackIndex){if(!tid)return String(fallbackIndex||0);const t=normalizeId(tid);if(opMap[t]){const num=opMap[t];if(window.opDebug){if(!window.opDebug[num])window.opDebug[num]=[];window.opDebug[num].push(t)}if(num.length<=2)return num;return num.substring(num.length-2)}if(typeof fallbackIndex!=='undefined')return String(fallbackIndex%100);let h=0;for(let i=0;i<t.length;i++){h=((h<<5)-h)+t.charCodeAt(i);h&=h}return String((Math.abs(h)%99)+1)}
function getDestCharByStops(arr,tid){if(tid&&destMap[tid]){const nm=destMap[tid];for(const m of destCharMap)if(m.pat.test(nm))return m.char;const n=normalizeName(nm);for(const m of destCharMap)if(m.pat.test(n))return m.char}if(arr&&arr.length>0){for(let i=arr.length-1;i>=0;i--){const nm=arr[i].stop_name||'';for(const m of destCharMap)if(m.pat.test(nm))return m.char}for(let i=0;i<Math.min(4,arr.length);i++){const nm=arr[i].stop_name||'';for(const m of destCharMap)if(m.pat.test(nm))return m.char}const joined=arr.map(x=>x.stop_name||'').join(' ');for(const m of destCharMap)if(m.pat.test(joined))return m.char}return'・'}
function buildSVG(){if(!svgWrap)throw new Error('svgWrap not found');svgWrap.innerHTML='';const rect=svgWrap.getBoundingClientRect();viewW=Math.max(1000,rect.width-20);viewH=Math.max(520,rect.height-20);const svg=document.createElementNS(SVG_NS,'svg');svg.setAttribute('viewBox','0 0 '+viewW+' '+viewH);svg.setAttribute('preserveAspectRatio','xMidYMid meet');svg.style.width='100%';svg.style.height='100%';svgWrap.appendChild(svg);const availableH=viewH-marginTop-marginBottom;rowY=[];stationPos=[];for(let r=0;r<ROWS;r++){const y=marginTop+r*100+50;rowY.push(y);const stations=ROWS_STATIONS[r]||[];const n=Math.max(1,stations.length);const availW=viewW-marginLeft-marginRight;const pos=[];for(let i=0;i<n;i++){const x=marginLeft+(n===1?availW/2:(i/(n-1))*availW);pos.push(x)}stationPos.push(pos);const topY=y-18,botY=y+18;const topLine=document.createElementNS(SVG_NS,'line');topLine.setAttribute('x1',marginLeft-10);topLine.setAttribute('x2',viewW-marginRight+10);topLine.setAttribute('y1',topY);topLine.setAttribute('y2',topY);topLine.setAttribute('class','track-line');svg.appendChild(topLine);const botLine=document.createElementNS(SVG_NS,'line');botLine.setAttribute('x1',marginLeft-10);botLine.setAttribute('x2',viewW-marginRight+10);botLine.setAttribute('y1',botY);botLine.setAttribute('y2',botY);botLine.setAttribute('class','track-line');svg.appendChild(botLine);for(let i=0;i<stations.length;i++){const rawName=stations[i];const name=displayStationName(rawName);const x=pos[i];const txt=document.createElementNS(SVG_NS,'text');txt.setAttribute('x',x);txt.setAttribute('y',y);txt.setAttribute('class','station-text');txt.textContent=name;svg.appendChild(txt);const bbox=txt.getBBox();const rectW=Math.max(20,bbox.width+12);const rectH=Math.max(18,bbox.height+8);const rectEl=document.createElementNS(SVG_NS,'rect');rectEl.setAttribute('x',x-rectW/2);rectEl.setAttribute('y',y-rectH/2);rectEl.setAttribute('width',rectW);rectEl.setAttribute('height',rectH);rectEl.setAttribute('class','station-rect');svg.insertBefore(rectEl,txt);const t1=document.createElementNS(SVG_NS,'line');t1.setAttribute('x1',x);t1.setAttribute('x2',x);t1.setAttribute('y1',topY-12);t1.setAttribute('y2',topY+12);t1.setAttribute('class','tick');svg.appendChild(t1);const t2=document.createElementNS(SVG_NS,'line');t2.setAttribute('x1',x);t2.setAttribute('x2',x);t2.setAttribute('y1',botY-12);t2.setAttribute('y2',botY+12);t2.setAttribute('class','tick');svg.appendChild(t2)}}const g=document.createElementNS(SVG_NS,'g');g.setAttribute('id','trains');svg.appendChild(g)}
function renderTrains(){if(!svgWrap)return;const svg=svgWrap.querySelector('svg');if(!svg)return;const g=svg.querySelector('#trains');if(!g)return;g.innerHTML='';let fallbackIndex=1;const renderedTrips=new Set();waitingTrains={};let trainCount=0;Object.keys(trips).forEach(tid=>{if(renderedTrips.has(tid))return;if(tripDayType[tid]&&tripDayType[tid]!==currentDayType)return;const seq=trips[tid];const route=tripRoute[tid]||'UNK';let trainRendered=false;const lastStop=seq[seq.length-1];const lastArrival=lastStop&&lastStop.arrival!=null?lastStop.arrival:null;if(lastArrival!=null){const opNum=opMap[tid];const dayType=tripDayType[tid]||'weekday';const opKey=dayType+'_'+opNum;const opTrips=tripsByOperation[opKey]||[];let nextTrip=null;for(let i=0;i<opTrips.length;i++){if(opTrips[i].tid===tid&&i+1<opTrips.length){nextTrip=opTrips[i+1];break}}if(currentTime>=lastArrival&&nextTrip&&currentTime<nextTrip.firstDeparture){const stationName=normalizeName(lastStop.stop_name||'');if(!waitingTrains[stationName])waitingTrains[stationName]=[];let direction='down';for(let i=seq.length-2;i>=0;i--){const a=seq[i],b=seq[i+1];const aName=normalizeName(a.stop_name||'');const bName=normalizeName(b.stop_name||'');let idxA=-1,idxB=-1;for(let r=0;r<ROWS;r++){const stations=ROWS_STATIONS[r];for(let si=0;si<stations.length;si++){const sNorm=normalizeName(stations[si]);if(sNorm===aName)idxA=si;if(sNorm===bName)idxB=si}if(idxA>=0&&idxB>=0)break}if(idxA>=0&&idxB>=0){direction=(idxB>idxA)?'down':'up';break}}direction=(direction==='up')?'down':'up';waitingTrains[stationName].push({tid,endTime:lastArrival,direction,nextDeparture:nextTrip.firstDeparture,nextTripId:nextTrip.tid});renderedTrips.add(tid);trainRendered=true;trainCount++}}if(trainRendered)return;for(let i=0;i<seq.length-1;i++){const a=seq[i],b=seq[i+1];if(a.departure==null||b.arrival==null)continue;if(currentTime<a.departure||currentTime>b.arrival)continue;const opNum=getOperationNumber(tid,fallbackIndex);if(opNum==='37'||opNum==='29'||opNum==='20'){console.log(`[DEBUG] 運用${opNum}番 時刻${secToHHMMSS(currentTime)}`);console.log('  前駅:',a.stop_name,'発',secToHHMMSS(a.departure));console.log('  次駅:',b.stop_name,'着',secToHHMMSS(b.arrival));console.log('  trip_id:',tid);console.log('  正規化前駅:',a.stop_name,'→',normalizeName(a.stop_name));console.log('  正規化次駅:',b.stop_name,'→',normalizeName(b.stop_name))}const aName=normalizeName(a.stop_name||'');const bName=normalizeName(b.stop_name||'');let rowIndex=-1,idxA=-1,idxB=-1,rowA=-1,rowB=-1;if(route==='SN'){const r=ROWS-1;const stations=ROWS_STATIONS[r];for(let si=0;si<stations.length;si++){const sNorm=normalizeName(stations[si]);if(sNorm===aName){rowA=r;idxA=si}if(sNorm===bName){rowB=r;idxB=si}}}else{for(let r=0;r<ROWS;r++){const stations=ROWS_STATIONS[r];for(let si=0;si<stations.length;si++){const sNorm=normalizeName(stations[si]);if(sNorm===aName&&rowA<0){rowA=r;idxA=si}if(sNorm===bName&&rowB<0){rowB=r;idxB=si}}}}if(rowA>=0&&rowB>=0){if(rowA===rowB){rowIndex=rowA}else{rowIndex=rowA;if(rowB===rowA+1){idxB=ROWS_STATIONS[rowA].length-1}else{idxB=idxA}}}if(rowIndex<0){for(let r=0;r<ROWS;r++){const stations=ROWS_STATIONS[r].map(s=>normalizeName(s));let ai=-1,bi=-1;for(let si=0;si<stations.length;si++){if(stations[si]===aName)ai=si;if(stations[si]===bName)bi=si}if(ai>=0&&bi>=0){rowIndex=r;idxA=ai;idxB=bi;break}}}if(rowIndex<0){rowIndex=(route==='SN')?ROWS-1:0;idxA=ROWS_STATIONS[rowIndex].indexOf(a.stop_name);idxB=ROWS_STATIONS[rowIndex].indexOf(b.stop_name)}if(rowIndex<0)continue;const pos=stationPos[rowIndex];const n=pos.length;const xA=pos[Math.max(0,Math.min(n-1,idxA>=0?idxA:0))];const xB=pos[Math.max(0,Math.min(n-1,idxB>=0?idxB:n-1))];let cx=xA;if(xB!==xA){const ratio=(currentTime-a.departure)/((b.arrival-a.departure)||1);cx=xA+(xB-xA)*ratio}const yCenter=rowY[rowIndex];const topY=yCenter-18,botY=yCenter+18;let cy=(idxB>idxA)?topY:(idxB<idxA?botY:topY);const circle=document.createElementNS(SVG_NS,'circle');circle.setAttribute('cx',cx);circle.setAttribute('cy',cy);circle.setAttribute('r',8);circle.setAttribute('class','train-circle');circle.style.fill=getComputedStyle(document.documentElement).getPropertyValue('--train-color')||'#fff';circle.style.cursor='pointer';circle.addEventListener('mouseenter',()=>showTooltip(tid,a,b,cx,cy));circle.addEventListener('mouseleave',hideTooltip);circle.addEventListener('click',ev=>{ev.stopPropagation();hideTooltip();showTimetable(tid)});g.appendChild(circle);const opNumFinal=getOperationNumber(tid,fallbackIndex++);const destChar=getDestCharByStops(seq,tid);const labelText=opNumFinal+destChar;const label=document.createElementNS(SVG_NS,'text');label.setAttribute('x',cx+(idxB>idxA?14:-14));label.setAttribute('y',cy+5);label.setAttribute('class','trip-label');label.setAttribute('text-anchor',idxB>idxA?'start':'end');label.textContent=labelText;g.appendChild(label);trainRendered=true;renderedTrips.add(tid);trainCount++;label.addEventListener('click',ev=>{ev.stopPropagation();hideTooltip();showTimetable(tid)});label.style.cursor='pointer';break}});Object.keys(waitingTrains).forEach(stationName=>{const trains=waitingTrains[stationName];if(!trains.length)return;let rowIndex=-1,stationIdx=-1;for(let r=0;r<ROWS;r++){const stations=ROWS_STATIONS[r];for(let si=0;si<stations.length;si++){if(normalizeName(stations[si])===stationName){rowIndex=r;stationIdx=si;break}}if(rowIndex>=0)break}if(rowIndex<0)return;const yCenter=rowY[rowIndex];const topY=yCenter-18,botY=yCenter+18;const xPos=stationPos[rowIndex][stationIdx];trains.forEach((train,index)=>{const direction=train.direction;const baseY=(direction==='down')?topY:botY;const offsetY=(direction==='down')?(-30-index*20):(30+index*20);const cy=baseY+offsetY;const circle=document.createElementNS(SVG_NS,'circle');circle.setAttribute('cx',xPos);circle.setAttribute('cy',cy);circle.setAttribute('r',8);circle.setAttribute('class','train-circle');circle.style.fill=getComputedStyle(document.documentElement).getPropertyValue('--train-color')||'#fff';circle.style.cursor='pointer';circle.style.opacity='0.8';circle.addEventListener('mouseenter',()=>showWaitingTooltip(train.tid,stationName,train.nextDeparture,xPos,cy,train.nextTripId));circle.addEventListener('mouseleave',hideTooltip);circle.addEventListener('click',ev=>{ev.stopPropagation();hideTooltip();showTimetable(train.nextTripId||train.tid)});g.appendChild(circle);const opNum=getOperationNumber(train.tid,fallbackIndex++);const destChar=getDestCharByStops(trips[train.tid],train.tid);const labelText=opNum+destChar;const label=document.createElementNS(SVG_NS,'text');label.setAttribute('x',xPos+14);label.setAttribute('y',cy+5);label.setAttribute('class','trip-label');label.setAttribute('text-anchor','start');label.textContent=labelText;label.style.opacity='0.8';g.appendChild(label);label.addEventListener('click',ev=>{ev.stopPropagation();hideTooltip();showTimetable(train.nextTripId||train.tid)});label.style.cursor='pointer'})});const trainCountDiv=document.getElementById('train_count');if(trainCountDiv)trainCountDiv.textContent='運行中: '+trainCount+'両'}
function showTooltip(tid,a,b,cx,cy){tooltip.style.display='block';const opNum=opMap[tid]||'?';const destChar=getDestCharByStops(trips[tid],tid);tooltip.innerHTML='<div style="font-weight:700">'+opNum+destChar+'</div><div style="margin-top:6px"><b>前:</b> '+(a.stop_name||'-')+' '+(a.departure?secToHHMMSS(a.departure):'')+'</div><div><b>次:</b> '+(b.stop_name||'-')+' '+(b.arrival?secToHHMMSS(b.arrival):'')+'</div><div style="margin-top:6px;font-size:11px;color:var(--muted)">クリックで時刻表表示</div>';const svg=svgWrap.querySelector('svg');const pt=svg.createSVGPoint();pt.x=cx;pt.y=cy;const sp=pt.matrixTransform(svg.getScreenCTM());tooltip.style.left=(sp.x+12)+'px';tooltip.style.top=(sp.y-28)+'px'}
function showWaitingTooltip(tid,stationName,nextDeparture,cx,cy,nextTripId){tooltip.style.display='block';const opNum=opMap[tid]||'?';const destChar=getDestCharByStops(trips[tid],tid);const nextDep=nextDeparture?secToHHMMSS(nextDeparture):'不明';let nextDestChar='?';if(nextTripId&&trips[nextTripId])nextDestChar=getDestCharByStops(trips[nextTripId],nextTripId);tooltip.innerHTML='<div style="font-weight:700">'+opNum+destChar+' → '+opNum+nextDestChar+'</div><div style="margin-top:6px"><b>状態:</b> '+stationName+'で待機中</div><div><b>次発:</b> '+nextDep+'</div><div style="margin-top:6px;font-size:11px;color:var(--muted)">クリックで次の運用の時刻表表示</div>';const svg=svgWrap.querySelector('svg');const pt=svg.createSVGPoint();pt.x=cx;pt.y=cy;const sp=pt.matrixTransform(svg.getScreenCTM());tooltip.style.left=(sp.x+12)+'px';tooltip.style.top=(sp.y-28)+'px'}
function hideTooltip(){tooltip.style.display='none'}
function showTimetable(tid){const modal=document.getElementById('timetableModal');const title=document.getElementById('timetableTitle');const body=document.getElementById('timetableBody');if(!modal||!title||!body){console.error('Modal not found');return}const arr=trips[tid]||[];const opNum=opMap[tid]||'?';const destChar=getDestCharByStops(arr,tid);const route=tripRoute[tid]||'UNK';const dayType=tripDayType[tid]==='holiday'?'土日祝':'平日';title.textContent=opNum+destChar+' - 時刻表';const destFullName={'伊':'伊野','後':'後免','高':'高知駅前','桟':'桟橋通五丁目','四':'桟橋通四丁目','橋':'はりまや橋','朝':'朝倉','鏡':'鏡川橋','枡':'枡形','知':'知寄町','文':'文珠通','介':'介良通','領':'領石通'}[destChar]||destChar;let html='<div class="timetable-info"><strong>便名:</strong> '+tid+'<br><strong>運用番号:</strong> '+opNum+'仕業<br><strong>行先:</strong> '+destFullName+'<br><strong>路線:</strong> '+(route==='EW'?'東西線':route==='SN'?'南北線':'不明')+'<br><strong>運用日:</strong> '+dayType+'</div><table class="timetable-table"><thead><tr><th>順序</th><th>駅名</th><th>到着</th><th>発車</th></tr></thead><tbody>';arr.forEach(stop=>{const displayName=displayStationName(stop.stop_name||'-');const arrival=stop.arrival!=null?secToHHMMSS(stop.arrival):'-';const departure=stop.departure!=null?secToHHMMSS(stop.departure):'-';html+='<tr><td>'+stop.seq+'</td><td>'+displayName+'</td><td>'+arrival+'</td><td>'+departure+'</td></tr>'});html+='</tbody></table>';body.innerHTML=html;modal.style.display='flex';console.log('Showing timetable for',tid)}
function closeTimetable(){const modal=document.getElementById('timetableModal');if(modal)modal.style.display='none'}
window.addEventListener('click',e=>{const modal=document.getElementById('timetableModal');if(e.target===modal)closeTimetable()});
function setupControls(){const nowBtn=document.getElementById('nowBtn');if(nowBtn)nowBtn.addEventListener('click',()=>{currentTime=nowSeconds();updateTimeUI();renderTrains()});document.querySelectorAll('.jump').forEach(btn=>btn.addEventListener('click',e=>{currentTime+=parseInt(e.currentTarget.dataset.s,10);updateTimeUI();renderTrains()}));const
firstBtn=document.getElementById('firstBtn');if(firstBtn)firstBtn.addEventListener('click',()=>{const t=getFirstDeparture();if(t){currentTime=t;updateTimeUI();renderTrains()}});const playBtn=document.getElementById('playBtn');if(playBtn)playBtn.addEventListener('click',e=>{const btn=e.currentTarget;if(anim==null){btn.textContent='停止 ■';playRate=parseFloat(document.getElementById('speed').value)||1;lastTs=null;anim=requestAnimationFrame(loop)}else{btn.textContent='再生 ▶';cancelAnimationFrame(anim);anim=null}});const dayTypeSelect=document.getElementById('dayType');if(dayTypeSelect){dayTypeSelect.addEventListener('change',e=>{currentDayType=e.target.value;renderTrains()})}setInterval(()=>{if(anim==null)updateTimeUI()},250)}
function loop(ts){if(!lastTs)lastTs=ts;const dt=(ts-lastTs)/1000;lastTs=ts;currentTime+=dt*playRate;updateTimeUI();renderTrains();anim=requestAnimationFrame(loop)}
function updateTimeUI(){const el=document.getElementById('bigTime');if(el)el.value=secToHHMMSS(Math.floor(currentTime))}
function getFirstDeparture(){let minT=Infinity;Object.values(trips).forEach(arr=>{if(arr.length>0){const t=(arr[0].departure!=null)?arr[0].departure:(arr[0].arrival!=null?arr[0].arrival:Infinity);if(t<minT)minT=t}});return isFinite(minT)?minT:null}
function hhmmssToSec(s){if(!s)return null;const p=s.split(':').map(x=>parseInt(x,10));if(p.length===2)return p[0]*3600+p[1]*60;if(p.length===3)return p[0]*3600+p[1]*60+p[2];return null}
function secToHHMMSS(t){t=Math.floor(((t%86400)+86400)%86400);const h=Math.floor(t/3600),m=Math.floor((t%3600)/60),s=t%60;return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')}
async function init(){try{svgWrap=document.getElementById('svgwrap');tooltip=document.getElementById('tooltip');if(!svgWrap)throw new Error('svgwrap not found');window.opDebug={};await loadUnyoIfExists();await loadData();console.log('=== 運用番号チェック ===');Object.keys(window.opDebug).forEach(opNum=>{const tids=window.opDebug[opNum];if(tids.length>1){console.warn(`運用${opNum}番が複数のtrip_idに割り当てられています:`,tids);tids.forEach(tid=>{const seq=trips[tid];if(seq&&seq.length>0){console.log(`  ${tid}: ${seq[0].stop_name} ${secToHHMMSS(seq[0].departure||0)} → ${seq[seq.length-1].stop_name} ${secToHHMMSS(seq[seq.length-1].arrival||0)}`)}})}});buildSVG();updateTimeUI();renderTrains();setupControls();setInterval(()=>{renderTrains()},3000);window.addEventListener('resize',()=>{ROWS_STATIONS=buildROWS_STATIONS();buildSVG();renderTrains()})}catch(err){alert('データ読み込みエラー: '+(err&&err.message?err.message:err));console.error(err)}}
document.addEventListener('DOMContentLoaded',init);
